---
title: "SCRNA Analysis"
author: "Piero Trevisan"
date: "24/10/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Introduction

In this demo, we will present an end-to-end analysis pipeline that starts from an HDF5 count data matrix (as typically obtained from the Human Cell Atlas portal) and proceeds through all steps leading to the inference and visualization of cell trajectories using pseudotime analysis with Slingshot.

```{r packages}
library(ggplot2)
library(mbkmeans)
library(NewWave)
library(scran)
library(scater)
library(scry)
library(slingshot)
library(SingleCellExperiment)
library(TENxPBMCData)
library(tradeSeq)
```

## Getting the data

```{r data}
sce <- TENxPBMCData("pbmc4k")
counts(sce)
setwd("/Users/USER/Documents/TESI/Dati")
groups <- readRDS("groups.rds")
set.seed(123)
names <- sample(groups)
colnames(sce) <- factor(names[1:4340])
colnames(sce)[colnames(sce)=="HBC*"]="HBC"
table(colnames(sce))
sce
```

## Filtering and normalization

### Removing low-quality cells
First, we remove low-quality cells.
In this step, we discard cells with an excessive proportion of mitochondrial genes or too few detected genes, as these often indicate damaged or low-quality cells.

```{r filter}
libsize <- colSums(counts(sce))
ngenes  <- colSums(counts(sce) > 0)
is.mito <- grepl("^MT-", rownames(sce), ignore.case = TRUE)
pct.mito <- colSums(counts(sce)[is.mito, ]) / libsize * 100
keep <- libsize > 1000 & ngenes > 500 & pct.mito < 20
sce <- sce[, keep]
```

### Removing lowly expressed genes

Next, we filter out lowly expressed genes to reduce noise and focus on informative features.
Here, we retain only genes with at least one UMI detected in at least 5\% of all cells.

```{r qc-gene-filter}
num_reads <- 1
num_cells <- 0.01*ncol(sce)
keep <- which(DelayedArray::rowSums(counts(sce) >= num_reads ) >= num_cells)
sce <- sce[keep,]
sce
```

### Normalization


We then compute the normalization factors and normalize the data.

```{r scran}
sce <- logNormCounts(sce)
sce
```

## Dimensionality reduction

### PCA on normalized values

Here, we compute the first 50 principal components using the top variable genes.

```{r pca}
sce <- scater::runPCA(sce, ncomponents = 50,
                      ntop = 1000,
                      scale = TRUE,
                      BSPARAM = BiocSingular::RandomParam())
labels <- as.factor(colnames(sce))
colData(sce)<- cbind(colData(sce), labels)
plotPCA(sce, colour_by = "labels")
```

## Pseudotime analisys

In this step, we infer cell trajectories and compute pseudotime values using Slingshot, based on the PCA embedding and cluster identities (“labels”).
The resulting pseudotime estimates for each lineage are stored in the sce object for downstream visualization and analysis.
```{r pseudotime}
sce <- slingshot(sce, clusterLabels = "labels", reducedDim = "PCA")
pt <- slingPseudotime(sce)
dim(pt)
sce$pseudotime_lineage1 <- pt[, 1]
sce$pseudotime_lineage2 <- pt[, 2]
sce$pseudotime_lineage3 <- pt[, 3]
table(is.na(sce$pseudotime_lineage1))
table(is.na(sce$pseudotime_lineage2))
table(is.na(sce$pseudotime_lineage3))
```

### Pseudotime visualization

Now we visualize the pseudotime trajectory inferred by Slingshot along each lineage, by plotting the cells in PCA space and coloring them according to their pseudotime values.

```{r plotpseudotimelinege1}
pca <- reducedDim(sce, "PCA")

df <- data.frame(
  PC1 = pca[,1],
  PC2 = pca[,2],
  pseudotime = sce$pseudotime_lineage1
)

df <- df[!is.na(df$pseudotime), ]

curve1 <- slingCurves(sce)[[1]] 

ggplot(df, aes(x = PC1, y = PC2, color = pseudotime)) +
  geom_point(size = 1.5) +
  geom_path(
    data = as.data.frame(curve1$s[ , 1:2]),
    aes(x = PC1, y = PC2),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 1.3
  ) +
  scale_color_viridis_c(direction = -1, option = "plasma") +
  labs(
    color = "Pseudotime (lineage 1)",
    title = "PCA colored by pseudotime with Slingshot curve (lineage 1)"
  ) +
  theme_classic()
```

```{r plotpseudotimelinege2}
df <- data.frame(
  PC1 = pca[,1],
  PC2 = pca[,2],
  pseudotime = sce$pseudotime_lineage2
)

df <- df[!is.na(df$pseudotime), ]

curve2 <- slingCurves(sce)[[2]]  

ggplot(df, aes(x = PC1, y = PC2, color = pseudotime)) +
  geom_point(size = 1.5) +
  geom_path(
    data = as.data.frame(curve2$s[ , 1:2]),
    aes(x = PC1, y = PC2),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 1.3
  ) +
  scale_color_viridis_c(direction = -1, option = "plasma") +
  labs(
    color = "Pseudotime (lineage 2)",
    title = "PCA colored by pseudotime with Slingshot curve (lineage 2)"
  ) +
  theme_classic()
```


```{r plotpseudotimelinege3}
df <- data.frame(
  PC1 = pca[,1],
  PC2 = pca[,2],
  pseudotime = sce$pseudotime_lineage3
)

df <- df[!is.na(df$pseudotime), ]

curve3 <- slingCurves(sce)[[3]]  

ggplot(df, aes(x = PC1, y = PC2, color = pseudotime)) +
  geom_point(size = 1.5) +
  geom_path(
    data = as.data.frame(curve3$s[ , 1:2]),
    aes(x = PC1, y = PC2),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 1.3
  ) +
  scale_color_viridis_c(direction = -1, option = "plasma") +
  labs(
    color = "Pseudotime (lineage 3)",
    title = "PCA colored by pseudotime with Slingshot curve (lineage 1)"
  ) +
  theme_classic()
```

